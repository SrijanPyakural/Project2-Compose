# docker-compose.yml
# Jenkins (custom image with Docker CLI) + Docker-in-Docker (DinD) over TLS
# UPDATE: mounts jenkins-data into DinD so the Jenkins workspace path exists
# on the remote Docker host for dockerized pipeline steps.

name: project2-compose

services:
  dind:
    image: docker:27-dind
    container_name: dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs                  # enable TLS certificates
    networks:
      jenkins:
        aliases: [docker]                          # Jenkins reaches daemon as "docker"
    volumes:
      - docker-certs-ca:/certs/ca                  # CA certs generated by DinD
      - docker-certs-client:/certs/client          # Client certs for Jenkins
      - docker-cache:/var/lib/docker               # Docker image/layer cache
      - jenkins-data:/var/jenkins_home             # âœ… share Jenkins home with DinD (fixes bind mount)
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 10s
      timeout: 5s
      retries: 5

  jenkins:
    # Custom Jenkins image that includes Docker CLI (so build/push stages work)
    build:
      context: ./jenkins                           # jenkins/Dockerfile installs docker.io
    container_name: jenkins
    user: root
    restart: unless-stopped
    environment:
      # Docker client inside Jenkins talks to the DinD daemon via TLS
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_CERT_PATH=/certs/client
      - DOCKER_TLS_VERIFY=1
    networks:
      jenkins: {}
    ports:
      - "8080:8080"                                # Jenkins Web UI
      - "50000:50000"                              # (optional) inbound agents
    volumes:
      - jenkins-data:/var/jenkins_home             # Persist jobs/config/plugins
      - docker-certs-client:/certs/client:ro       # Read-only client TLS certs
    depends_on:
      dind:
        condition: service_healthy

networks:
  jenkins: {}

volumes:
  jenkins-data:
  docker-certs-ca:
  docker-certs-client:
  docker-cache:

